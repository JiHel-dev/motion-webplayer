$(function(){function p(){function a(a){var n=[],c=[],f=[],d=[],g=[];if(0!=a)if("hour"==l){$.each(a,function(a,b){n.push(moment(b.Hour,"HH"));c.push(b.Left_Emptied_bins);f.push(b.Right_Emptied_bins);d.push(b.Middle_Emptied_bins);g.push(b.Large_Emptied_bins)});var h=new Chart(e,{type:"bar",data:{labels:n,datasets:[{label:"Left_bin",backgroundColor:"#7c85ab",data:c},{label:"Right_bin",backgroundColor:"#a0cd7c",data:f},{label:"Middle_bin",backgroundColor:"#efc163",data:d},{label:"Large_bin",backgroundColor:"#d99da6",
data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{hour:"H"},minUnit:"hour",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x"}}})}else"day"==l?($.each(a,function(a,b){n.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));c.push(b.Left_Emptied_bins);f.push(b.Right_Emptied_bins);d.push(b.Middle_Emptied_bins);g.push(b.Large_Emptied_bins)}),h=new Chart(e,{type:"bar",
data:{labels:n,datasets:[{label:"Left_bin",backgroundColor:"#7c85ab",data:c},{label:"Right_bin",backgroundColor:"#a0cd7c",data:f},{label:"Middle_bin",backgroundColor:"#efc163",data:d},{label:"Large_bin",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{hour:"H"},minUnit:"hour",stepSize:1},ticks:{callback:function(a,b,c){return a+"h"},fontColor:"#666",display:!0},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},
tooltips:{callbacks:{}},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x"}}}),$("#reset_zoom_emptied_bin_btn").click(function(){h.resetZoom()})):"week"==l?($.each(a,function(a,b){n.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));c.push(b.Left_Emptied_bins);f.push(b.Right_Emptied_bins);d.push(b.Middle_Emptied_bins);g.push(b.Large_Emptied_bins)}),h=new Chart(e,{type:"bar",data:{labels:n,datasets:[{label:"Left_bin",backgroundColor:"#7c85ab",data:c},{label:"Right_bin",backgroundColor:"#a0cd7c",
data:f},{label:"Middle_bin",backgroundColor:"#efc163",data:d},{label:"Large_bin",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{day:"MMM DD"},minUnit:"day",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x",limits:{max:.5,min:10}}}}),$("#reset_zoom_emptied_bin_btn").click(function(){h.resetZoom()})):"month"==l&&($.each(a,function(a,
b){n.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));c.push(b.Left_Emptied_bins);f.push(b.Right_Emptied_bins);d.push(b.Middle_Emptied_bins);g.push(b.Large_Emptied_bins)}),h=new Chart(e,{type:"bar",data:{labels:n,datasets:[{label:"Left_bin",backgroundColor:"#7c85ab",data:c},{label:"Right_bin",backgroundColor:"#a0cd7c",data:f},{label:"Middle_bin",backgroundColor:"#efc163",data:d},{label:"Large_bin",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",
time:{displayFormats:{day:"MMM DD"},minUnit:"day",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x",limits:{max:.5,min:10}}}}),$("#reset_zoom_emptied_bin_btn").click(function(){h.resetZoom()}));else $("#ErrorBox").append('<div class="modal" id="myModal">                                <div class="modal-dialog">                                    <div class="modal-content">                                        <div class="modal-header">                                            <h5 class="modal-title trn" style="font-weight: normal; margin-left: auto">modal.Info</h5>                                            <button type="button" class="close" data-dismiss="modal">&times;</button>                                        </div>                                        <div class="modal-body">                                        <i class="fa fa-exclamation-circle fa-fw" style="color: red;"></i>&nbsp;<span class="trn">error.noData</span>                                        </div>                                        <div class="modal-footer">                                            <button type="button" class="btn btn-primary trn" data-dismiss="modal">button.Close</button>                                        </div>                                    </div>                                </div>                            </div>'),
$("#myModal").modal(),$("#myModal").trigger("traduction")}$("#emptiedBinChart").remove();$("#emptied_bin_div").append('<canvas id="emptiedBinChart"></canvas>');var e=document.getElementById("emptiedBinChart").getContext("2d");e.canvas.height=275;var c=[],l=localStorage.aggregationValue;localStorage.selectedVehicletab&&localStorage.truckList?(c=JSON.parse(localStorage.selectedVehicletab),c=c.id):c=0;var k=$("#start-timestamp-data").val()+" 00:00:00",m=$("#end-timestamp-data").val()+" 23:59:59";(new Date(m)).toLocaleDateString(localStorage.language,
{month:"long"});$.ajax({type:"POST",url:"https://connect.faun.fr/api/public/emptied_bin_indic/"+c,dataType:"json",data:{timezone:localStorage.timezone,aggregation:l,start_timestamp:k,end_timestamp:m},headers:{"faun-token":token},success:function(c){a(c)},error:function(a){console.log(a)}})}function q(){function a(a){var c=[],h=[],f=[],d=[],g=[];if(0!=a)if("hour"==l)$.each(a,function(a,b){c.push(moment(b.Hour,"HH"));h.push(b.Left_chair_cycle_1);f.push(b.Left_chair_cycle_2);d.push(b.Right_chair_cycle_1);
g.push(b.Right_chair_cycle_2)}),new Chart(e,{type:"bar",data:{labels:c,datasets:[{label:"Left_chair_cycle_1",backgroundColor:"#7c85ab",data:h},{label:"Left_chair_cycle_2",backgroundColor:"#a0cd7c",data:f},{label:"Right_chair_cycle_1",backgroundColor:"#efc163",data:d},{label:"Right_chair_cycle_2",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{hour:"H"},minUnit:"hour",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},
stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x"}}});else if("day"==l){$.each(a,function(a,b){c.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));h.push(b.Left_chair_cycle_1);f.push(b.Left_chair_cycle_2);d.push(b.Right_chair_cycle_1);g.push(b.Right_chair_cycle_2)});var m=new Chart(e,{type:"bar",data:{labels:c,datasets:[{label:"Left_chair_cycle_1",backgroundColor:"#7c85ab",data:h},{label:"Left_chair_cycle_2",backgroundColor:"#a0cd7c",data:f},{label:"Right_chair_cycle_1",
backgroundColor:"#efc163",data:d},{label:"Right_chair_cycle_2",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{hour:"H"},minUnit:"hour",stepSize:1},ticks:{callback:function(a,b,c){return a+"h"}},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},tooltips:{callbacks:{}},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x"}}});$("#reset_zoom_lifter_cycle_btn").click(function(){m.resetZoom()})}else"week"==
l?($.each(a,function(a,b){c.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));h.push(b.Left_chair_cycle_1);f.push(b.Left_chair_cycle_2);d.push(b.Right_chair_cycle_1);g.push(b.Right_chair_cycle_2)}),m=new Chart(e,{type:"bar",data:{labels:c,datasets:[{label:"Left_chair_cycle_1",backgroundColor:"#7c85ab",data:h},{label:"Left_chair_cycle_2",backgroundColor:"#a0cd7c",data:f},{label:"Right_chair_cycle_1",backgroundColor:"#efc163",data:d},{label:"Right_chair_cycle_2",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,
maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{day:"MMM D"},minUnit:"day",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x",limits:{max:.5,min:10}}}}),$("#reset_zoom_lifter_cycle_btn").click(function(){m.resetZoom()})):"month"==l&&($.each(a,function(a,b){c.push(moment(b.Timestamp,"YYYY-MM-DD HH:mm:ss"));h.push(b.Left_chair_cycle_1);f.push(b.Left_chair_cycle_2);d.push(b.Right_chair_cycle_1);
g.push(b.Right_chair_cycle_2)}),m=new Chart(e,{type:"bar",data:{labels:c,datasets:[{label:"Left_chair_cycle_1",backgroundColor:"#7c85ab",data:h},{label:"Left_chair_cycle_2",backgroundColor:"#a0cd7c",data:f},{label:"Right_chair_cycle_1",backgroundColor:"#efc163",data:d},{label:"Right_chair_cycle_2",backgroundColor:"#d99da6",data:g}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",time:{displayFormats:{day:"MMM DD"},minUnit:"day",stepSize:1},stacked:!0}],yAxes:[{ticks:{beginAtZero:!0},
stacked:!0}]},legend:{display:!0,position:"top"},zoom:{enabled:!0,drag:!0,mode:"x",limits:{max:.5,min:10}}}}),$("#reset_zoom_lifter_cycle_btn").click(function(){m.resetZoom()}));else $("#ErrorBox").append('<div class="modal" id="myModal">                                <div class="modal-dialog">                                    <div class="modal-content">                                        <div class="modal-header">                                            <h5 class="modal-title trn" style="font-weight: normal; margin-left: auto">modal.Info</h5>                                            <button type="button" class="close" data-dismiss="modal">&times;</button>                                        </div>                                        <div class="modal-body">                                        <i class="fa fa-exclamation-circle fa-fw" style="color: red;"></i>&nbsp;<span class="trn">error.noData</span>                                        </div>                                        <div class="modal-footer">                                            <button type="button" class="btn btn-primary trn" data-dismiss="modal">button.Close</button>                                        </div>                                    </div>                                </div>                            </div>'),
$("#myModal").modal(),$("#myModal").trigger("traduction")}$("#lifterCycleChart").remove();$("#lifter_cycles_div").append('<canvas id="lifterCycleChart"></canvas>');var e=document.getElementById("lifterCycleChart").getContext("2d");e.canvas.height=275;var c=[],l=localStorage.aggregationValue;localStorage.selectedVehicletab&&localStorage.truckList?(c=JSON.parse(localStorage.selectedVehicletab),c=c.id):c=0;var k=$("#start-timestamp-data").val()+" 00:00:00",m=$("#end-timestamp-data").val()+" 23:59:59";
(new Date(m)).toLocaleDateString(localStorage.language,{month:"long"});$.ajax({type:"POST",url:"https://connect.faun.fr/api/public/chair_cycle_indic/"+c,dataType:"json",data:{timezone:localStorage.timezone,aggregation:l,start_timestamp:k,end_timestamp:m},headers:{"faun-token":token},success:function(c){a(c)},error:function(a){console.log(a)}})}setTimeout(function(){$("#loadingDiv").fadeOut(200,function(){$("#loadingDiv").remove()})},200);console.log("Data Analysis");FaunUtilityModule.get.timezone();
$.ajax({type:"GET",url:"https://connect.faun.fr/api/public/user_info",dataType:"json",data:{},headers:{"faun-token":token},timeout:5E3,success:function(a){FaunUtilityModule.stock.userInfo(a)},error:function(a){console.log(a)}});FaunDataAnalysisModule.aggregation.translateDisplayAggregation();$("#measureChart").remove();$("#measure_chart_div").append('<canvas id="measureChart"></canvas>');document.getElementById("measureChart").getContext("2d").canvas.height=450;$.ajax({type:"POST",url:"https://connect.faun.fr/api/public/geolocations_last_auth_vehicles",
dataType:"json",data:{timezone:localStorage.timezone},headers:{"faun-token":token},success:function(a){FaunUtilityModule.stock.listAuthorizedVehicle(a)},error:function(a){console.log(a)}});var v=localStorage.aggregationValue;$("#start-timestamp-data, #end-timestamp-data").datetimepicker({format:"Y-m-d",timepicker:!1,minDate:"2018-06-01",maxDate:"2118-06-01",startDate:new Date,defaultDate:new Date,weeks:!0,step:15});var k=new Date,r=k.getMonth(),t=k.getDate(),u=k.getFullYear();k.getHours();k.getMinutes();
k.getSeconds();"row"==v?($("#start-timestamp-data, #end-timestamp-data").datetimepicker({format:"Y-m-d H:i:s",minDate:"2018-06-01",maxDate:"2118-06-01",startDate:new Date,defaultDate:new Date,weeks:!0,step:15}),$("#end-timestamp-data").datetimepicker({value:new Date}),$("#start-timestamp-data").datetimepicker({value:new Date(u,r,t,0,0,0)})):($("#end-timestamp-data").datetimepicker({value:new Date}),$("#start-timestamp-data").datetimepicker({value:new Date(u,r,t,0,0,0)}),$("#startTimestampData").hide());
p();q();$.ajax({type:"GET",url:"https://connect.faun.fr/api/public/measure_type",dataType:"json",data:{timezone:localStorage.timezone},headers:{"faun-token":token},success:function(a){$("#selectMeasureOption").remove();$.each(a,function(a,c){$("#selectMeasure").append("<option>"+c.name+"</option>")});a=$("#selectMeasure");a.html(a.find("option").sort(function(a,c){return $(a).text()>$(c).text()?1:-1}));$("#selectMeasure").get(0).selectedIndex=0},error:function(a){console.log(a)}});$("#start-timestamp, #end-timestamp").datetimepicker({format:"Y-m-d H:i:s",
minDate:"2018-06-01",maxDate:"2118-06-01",startDate:new Date,defaultDate:new Date,weeks:!0,step:15});$("#select_affichage_btn").change(function(){$(this).prev("#select_affichage_btn");var a=$(this).find("option:selected")[0].innerHTML;localStorage.selectedDisplayValue=a;$("#plot-btn").trigger("click")});$("#btn-group-affichage > label.btn").on("click",function(){var a=$(this).find(".trn").html();localStorage.aggregationValue="fr"==localStorage.language?"Jour"==a?"day":"Semaine"==a?"week":"Mois"==
a?"month":"Brut"==a?"raw":"week":a;p();q()});$("#selectVehicleIdx").change(function(){var a=$("#selectVehicleIdx").val(),e=JSON.parse(localStorage.truckList);for(e.index=0;e.index<e.length;e.index++)a==e[e.index].rcv_number&&(selected_vehicle_id=e[e.index].vehicle_id);localStorage.selectedVehicletab=JSON.stringify({name:a,id:selected_vehicle_id});p();q()});$("#end-timestamp-data, #start-timestamp-data").change(function(){p();q()});$("#end-timestamp").datetimepicker({value:new Date});$("#start-timestamp").datetimepicker({value:function(a){a.setDate(a.getDate()-
1);return a}(new Date)});$("#plot-btn").on("click",function(){function a(a){var c=[],m=[];if(0!=a){$.each(a,function(a,d){$("#tbody-measures").append('<tr id="tr-measures"><td class="trn">'+d.timestamp+'</td><td class="trn">'+d.name+'</td><td class="trn">'+d.value+'</td><td class="trn">'+d.unit+"</td></tr>");c.push(d.timestamp);m.push(d.value)});$("#MeasureTable").DataTable({responsive:!0});var k=new Chart(e,{type:"line",data:{labels:c,datasets:[{label:l,backgroundColor:"rgba(100, 200, 255, 0)",borderColor:"rgba(0, 100, 200, 0.75)",
hoverBackgroundColor:"rgba(200, 200, 200, 1)",hoverBorderColor:"rgba(200, 200, 200, 1)",data:m}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{xAxes:[{type:"time",distribution:"linear",time:{displayFormats:{millisecond:"DD-MM-YYYY HH:mm:ss",second:"YYYY-MM-DD HH:mm:ss",minute:"YYYY-MM-DD HH:mm:ss",hour:"YYYY-MM-DD HH:mm:ss",day:"YYYY-MM-DD HH:mm:ss",week:"YYYY-MM-DD HH:mm:ss",month:"YYYY-MM-DD HH:mm:ss",quarter:"YYYY-MM-DD HH:mm:ss",ear:"YYYY-MM-DD HH:mm:ss"}}}]},legend:{display:!0,position:"right"},
pan:{enabled:!0,mode:"x",speed:1E4,threshold:1E4},zoom:{enabled:!0,drag:!0,mode:"x"}}});$("#reset_zoom_btn").click(function(){k.resetZoom()})}else $("#ErrorBox").append('<div class="modal" id="myModal">                                <div class="modal-dialog">                                    <div class="modal-content">                                        <div class="modal-header">                                            <h5 class="modal-title trn" style="font-weight: normal; margin-left: auto">modal.Info</h5>                                            <button type="button" class="close" data-dismiss="modal">&times;</button>                                        </div>                                        <div class="modal-body">                                        <i class="fa fa-exclamation-circle fa-fw" style="color: red;"></i>&nbsp;<span class="trn">error.noData</span>                                        </div>                                        <div class="modal-footer">                                            <button type="button" class="btn btn-primary trn" data-dismiss="modal">button.Close</button>                                        </div>                                    </div>                                </div>                            </div>'),
$("#myModal").modal(),$("#myModal").trigger("traduction")}$("#tr-measures").remove();$("#measureChart").remove();$("#measure_chart_div").append('<canvas id="measureChart"></canvas>');var e=document.getElementById("measureChart").getContext("2d");e.canvas.height=450;var c=$("#selectVehicle option:selected").text(),l=$("#selectMeasure option:selected").text();for(rcv_num_id.index=0;rcv_num_id.index<rcv_num_id.length;rcv_num_id.index++)c==rcv_num_id[rcv_num_id.index].rcv_number&&(selected_vehicle_id=
rcv_num_id[rcv_num_id.index].vehicle_id);c=$("#start-timestamp").val();var k=$("#end-timestamp").val();(new Date(k)).toLocaleDateString(localStorage.language,{month:"long"});$.ajax({type:"POST",url:"https://connect.faun.fr/api/public/measures/"+selected_vehicle_id,dataType:"json",data:{timezone:localStorage.timezone,measure_name:l,start_timestamp:c,end_timestamp:k},headers:{"faun-token":token},success:function(c){a(c)},error:function(a){console.log(a)}})})});